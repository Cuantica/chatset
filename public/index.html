<!doctype html>
<html>
  <head>
    <title>Chatset</title>
    <link rel="stylesheet" type="text/css" href="css/styles.css">
  </head>
  <body>
    <div class="app-stream">
        <!-- Datos a ser enviados -->
        <div class="chat-data-user">
            <form action="" id="form-data-user">
                <label id="user_name">Nombre:</label>
                <input type="text" name="user_name" id="user_name">

                <label id="user_name">Tel:</label>
                <input type="text" name="user_phone" id="user_phone">

                <label id="user_name">Direc:</label>
                <input type="text" name="user_dir" id="user_dir">

                <label id="user_name">Mail:</label>
                <input type="text" name="user_mail" id="user_mail">

                <input type="submit" value="Contactar">
            </form>
        </div>


        <!-- Pantalla de Chat -->
        <div class="container-chat content-hidden">
            <ul id="messages"></ul>
            <form action="" id="form-message-send" class="input-message">
                <input id="message-input" autocomplete="off" /><button>Enviar</button>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
    <script>
        var socket = io();
        var userStream; // contiene los datos del usuarios

        // Envio de nuevo usuario
        // Enviamos los datos del usuarios, mejorar validciones
        $("#form-data-user").on("submit", function(ev){
            ev.preventDefault();
            let user_data = {};
            let flag_user_data = false;
            $(this).children("input[type=text]").each((index, element) => {
                let element_val = $(element).val();
                if('' == $(element).val().trim())
                    flag_user_data = true;

                user_data[$(element).attr('name')] = $(element).val();
            });
            socket.emit("user-send-data", user_data);
        
            $(".chat-data-user").addClass("content-hidden");
            $(".container-chat").removeClass("content-hidden");
        });


        // Envio de mensaje y datos del usuarios
        $('#form-message-send').submit(function(){
            let msgComponent = {};
            msgComponent.text = $('#message-input').val();
            msgComponent.user_id = userStream['_id'];
            msgComponent._created_up = new Date();

            if ('' != msgComponent.text.trim('')){
                socket.emit('chat message', msgComponent);
                $('#message-input').val('');     
            }
            else
                console.log('Error');
            
            return false;
        });

        // Visualizamos mensaje enviado
        socket.on('chat message', function(msgComponent){
            $('#messages').append($('<li>').text(msgComponent.text));
        });

        
        // Usuario creado y almacenado los datos en el local storage
        socket.once('user-added', function(userData){
            for (const key in userData) {
                if (userData.hasOwnProperty(key)) {
                    localStorage.setItem(key, userData[key]);        
                }
            }
            userStream = userData;
        });

        

    </script>
    
  </body>
</html>